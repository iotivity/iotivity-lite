IoTivity-Lite Android port
-------------------------------------------------

Introduction
=================================================
This contains the instructions to build the Android Source code.

A tool called SWIG is used to generate Java language bindings for IoTivity-lite.  SWIG is an
interface compiler that connects programs written in C and C++ with other languages such as Java.

SWIG is not a stubs generator.  It produces code that can be compiled and used.  The output is
generated by a tool.  For this reason there is no fancy encapsulation of the code to make it
appear more like what most Java developers would expect.  The output with very few
exceptions are just a collection of classes filled with static methods.  This has both the
advantage and disadvantage that the way the code is used in Java is similar to the way it is used
in C.  This means the code does not resemble what a typical Java programmer expects but it is easy
for someone familiar with the C code to follow the flow of the code.

The Java output is still in early development and is expected to change.  Since the Java output
is just a thin layer on top of IoTivity-lite C code any programs developed using Java are
expected to be as stable as the underlying C code.

Getting Started
=================================================
To use this code you will need the following:
  - git version control system
  - IoTivity-lite
  - SWIG
  - Java Development kit.
  - Android SDK
  - Android NDK
  - Gradle build system

The following contains instructions to obtain and run the tools on Linux.

### Get git
It can be installed on Ubuntu Linux using the following command.

    sudo apt-get install git

### Get IoTivity-Lite
Checkout IoTivity-lite git project run the following command to get a anonymous copy of
iotivity-lite (a.k.a. iotivity-constrained).  Checkout the SWIG branch.

    git clone https://gerrit.iotivity.org/gerrit/iotivity-constrained
    git checkout -t origin/swig

Since this is an anonymous download you will not be able to push any changes up to the project.
IoTivity is managed by the Linux Foundation.  If you are planning on contributing back to
IoTivity you will need to have a [Linux Foundation ID](https://identity.linuxfoundation.org/).
 The Linux Foundation ID can then be used to log into the Gerrit server for IoTivity-lite.
[gerrit.iotivity.org](https://gerrit.iotivity.org/gerrit/#/admin/projects/iotivity-constrained)

Follow the instruction [here](https://wiki.iotivity.org/how_to_use_gerrit) to gain push access
to the project.

### Get SWIG
SWIG can be installed on Ubuntu Linux using the following command.

    sudo apt-get install swig

### Get Java Development Kit
The SWIG output should work with Java 6 and newer.  The Output has been tested against Oracle
Java 8 and OpenJDK 1.8.

On Ubuntu Linux OpenJDK can be downloaded using the following command.

    apt-get search openjdk
    sudo apt-get install openjdk-8-jdk
    # You may wish to choose a different version of openjdk
    # if you have installed multiple versions of Java you may need to switch
    # the active version using the update-java-alternatives tool.
    sudo apt-get install java-common
    update-java-alternatives

Install OpenJDK on Fedora Linux

    dnf search openjdk
    sudo dnf install java-1.8.0-openjdk.x86_64
    # or use dnf install <openjdk-package-name>
    # if you have installed multiple versions of Java you may need to switch
    # the active version
    sudo alternatives --config java

### Android SDK
</** TODO **/>

### Android NDK
Download Android NDK

https://developer.android.com/ndk/downloads/index.html

Unzip downloaded package.

    cd <NDK>/build/tools
    ./make_standalone_toolchain.py --arch <architecture> --api <level> --install-dir <path>

valid values for `--arch`
 - arm
 - arm64
 - x86
 - x86_64

The `make_standalone_toolchain` script only supports api level 16 and newer. We recommend using api
level 23 or newer.

For example:

    ./make_standalone_toolchain.py --arch arm --api 23 --install-dir ~/android-arm-23

For further setup see:

https://developer.android.com/ndk/guides/standalone_toolchain.html

### Gradle
</** TODO **/>

### Verify installation of needed tools
The scripts used assume all the needed tools are on PATH and are accessible without knowing the
location of the tool.

Run the following to verify each tool.  At this time there are no known issues limiting users to
the same version of the tools as were used for developement.  Feel free to use the latest verson of
all the developement tools.

git

    git --version

example of expected output (newest version recommended)

    git version 2.20.1

---
SWIG

    swig -version

example of expected output (newest version recommended)

    SWIG Version 3.0.12
    Compiled with g++ [x86_64-redhat-linux-gnu]
    Configured options: +pcre
    Please see http://www.swig.org for reporting bugs and further information

---
Java

    java -version
    javac -version

example of expected output

    openjdk version "1.8.0_191"
    OpenJDK RuntimeEnvironment (build 1.8.0_191-b12)
    OprnJDK 64-bit Server VM (build 25.191-b12, mixed mode)

    javac 1.8.0_191

Building IoTivity-Lite libraries
=================================================
Navigate to `<iotivity-lite>/swig/java_lang`
Get SWIG to generate the Java and JNI code:

    ./build_swig.sh android

Build `iotivity-lite.jar`:

    ./build-iotivity-lite.sh

Now copy the `iotivity-lite.jar` to the Android app libs directory for each project:

    cp -v iotivity-lite.jar ../apps/android_simple_server/SimpleServer/app/libs/iotivity-lite.jar
    cp -v iotivity-lite.jar ../apps/android_simple_client/SimpleClient/app/libs/iotivity-lite.jar

Note that these commands are in the file `build-iotivity-lite.sh` and can be uncommented-out.

To build the `libiotivity-lite-jni.so` shared object library for Android cd to

    cd <iotivity-lite>/android/port

This Makefile-swig uses then the Android NDK that was installed in the **C Build Tools** section
above.

Either set ANDROID_API and ANDROID_BASE in the Makefile-swig  or invoke like this:

    make NDK_HOME=/opt/android-ndk ANDROID_API=23

Example Usage:

    make -f Makefile-swig DYNAMIC=1 TCP=1 IPV4=1 SECURE=1 DEBUG=1

or

    make NDK_HOME=~/android-arm-23 ANDROID_API=23 -f Makefile-swig DYNAMIC=1 TCP=1 IPV4=1 SECURE=1 DEBUG=1

Copy the libiotivity-lite-jni.so to the appropriate jniLibs sub-directories for each project:

    cp libiotivity-lite-jni.so ../../swig/apps/android_simple_client/SimpleClient/app/src/main/jniLibs/armeabi/
    cp libiotivity-lite-jni.so ../../swig/apps/android_simple_server/SimpleServer/app/src/main/jniLibs/armeabi/

The Makefile-swig also contains a version of these same build instructions.

Building and Running Samples
=================================================
All samples have the default out of the box behavior of IoTivity which means they are are not
onboarded or provisioned.  The default security will prevent the samples from communicating with
one another till onboarding and provisioning has been completed.  See the following section
**Onboarding and Provisioning** for instructions on using the onboarding tool that is part of
iotivity-lite.

A sample server and client can be found in `<iotivity-lite>/swig/apps/<sample>`

Note that gradlew will require a `local.properties` to exist or ANDROID_HOME to be defined.  An
installation of Android Studio should create the `local.properties` file.

The server sample is in `android_simple_server/SimpleServer`.  To build and install the sample
execute the following command:

    ./gradlew installDebug

The client sample is in `android_simple_client/SimpleClient`.  To build and install the sample
execute the following command:

    ./gradlew installDebug

Onboarding and Provisioning
=================================================
### Runing the onboarding tool

At this time there are two versions of the onboarding tool.  The C version and the Java version.
The versions are identical. The exception being that the C version is currently built only for
Linux. While the Java version is available for both windows and Linux.  It does not matter which
version of the onboarding tool.

The C version of the onboarding tool can be found in `<iotivity-lite>/port/linux` see Linux build
instructions.

A Java version of the onboarding-tool that will run on Windows or Linux can be found

A sample server and client can be found in `<iotivity-lite>/swig/apps/java_onboarding_tool`

Assuming you have already followed the `Building for Linux` or `Building for Windows` build
instructions the following commands can be used to build and run the onboarding tool.

Linux:

    build-onboarding-tool-lite.sh
    run-onboarding-tool-lite.sh

Windows

    sh build-onboarding-tool-lite.sh
    run-onboarding-tool-lite.cmd

### Simple Step-by-Step guide for onboarding and provisioning

This guide assumes you are starting one discoverable device at a time. Multiple devices can be
discovered and onboarded at the same time however it becomes the responsibility of the user to
figure out which UUID belongs to which device.

Once you have successfully onboarded the samples the first time using the following step-by-step
options feel free to RESET the devices and play around with different provisioning options.

### (Step 1) Onboard and Provision the Server

 - start the server sample
 - start onboarding tool it will print the following menu:
```
    ################################################
    OCF 1.3 Onboarding Tool
    ################################################
    [0] Display this menu
    -----------------------------------------------
    [1] Discover un-owned devices
    [2] Discover owned devices
    -----------------------------------------------
    [3] Take ownership of device (Just-works)
    [4] Provision pair-wise credentials
    [5] Provision ACE2
    -----------------------------------------------
    [6] RESET device
    -----------------------------------------------
    [9] Exit
    ################################################

    Select option:
```

 - Type `1` **Enter** to _Discover un-owned devices_ this should display a something similar to
   this

    Discovered unowned device: c3e5c231-9f95-4859-6d11-87f40b1977d5 at:
    [fe80:0000:0000:0000:05a8:81bd:23cf:3882]:59584
    [fe80:0000:0000:0000:05a8:81bd:23cf:3882]:59585

 - Type `3` **Enter** to _Take ownership of device_
   - Type `0` **Enter**. If you have multiple unowned devices you will have to select the correct
     device from the list.  The following should be displayed

    Successfully issued request to perform ownership transfer

 - Type `2` **Enter** to _Discover owned devices_ the device you just took ownership of should be
   listed.
 - Type `5` **Enter** to _Provision ACE2_. There are many ways to properly provision the device.
   This will give instruction for using wildcard provisioning.
   - Type `0` **Enter**. If you have multiple unowned devices you will have to select the correct
     device from the list.
   - Type `1` **Enter** for an _auth-crypt_ ACE
   - Type `1` **Enter** in response to `Enter number of resources in this ACE:`
   - Type `0` **Enter** in response to `Have resource href? [0-No, 1-Yes]:`
   - Type `1` **Enter** in response to `Set wildcard resource? [0-No, 1-Yes]:`
   - Type `2` **Enter** to select the `[2]: All discoverable resources` option
   - Type `0` **Enter** in response to `Enter number of resource types [0-None]:`
   - Type `0` **Enter** in response to `Enter number of interfaces [0-None]`
   - Type `0` **Enter** for CREATE, `1` **Enter** for RETRIEVE, `1` **Enter** for UPDATE, `0`
     **Enter** for DELETE, and `1` **Enter** for NOTIFY.
   - `Successfully issued request to provision ACE` should be printed on the screen upon success

Example output from following the above listed commands:

    Provision ACL2
    My Devices:
    [0]: 33cd6782-00f3-49db-624e-fda26e945c8d


    Select device for provisioning: 0

    Subjects:
    [0]: anon-clear
    [1]: auth-crypt
    [2]: 33cd6782-00f3-49db-624e-fda26e945c8d

    Select subject: 1

    Enter number of resources in this ACE: 1

    Resource properties
    Have resource href? [0-No, 1-Yes]: 0

    Set wildcard resource? [0-No, 1-Yes]: 1
    [1]: All resources
    [2]: All discoverable resources
    [3]: All non-discoverable resources

    Select wildcard resource: 2
    Enter number of resource types [0-None]: 0
    Enter number of interfaces [0-None]0

    Set ACE2 permissions
    CREATE [0-No, 1-Yes]: 0
    RETRIEVE [0-No, 1-Yes]: 1
    UPDATE [0-No, 1-Yes]: 1
    DELETE [0-No, 1-Yes]: 0
    NOTIFY [0-No, 1-Yes]: 1

    Successfully issued request to provision ACE

### (Step 2) Onboard the client
 - start the client sample
 - Type `1` **Enter** to _Discover un-owned devices_
 - Type `3` **Enter** to _Take ownership of device_
   - Type `0` **Enter**. If you have multiple unowned devices you will have to select the correct
     device from the list.
  - Type `2` **Enter** to _Discover owned devices_ the server and client should be listed

### (Step 3) Pair Server and Client
  - Type `4` **Enter** to _Provision pair-wise credentials_
  - Type `0` **Enter** `1` **Enter** to pair the client and server. If you have multiple owned
    devices you will have to select the correct devices from the list.

### (Step 4) Restart and Test
The samples should be onboarded and provisioned. Restart the server and client they should discover
each other and run without difficulty.

Send Feedback
=================================================
The SWIG generated language bindings are still in an early stage.  The work is subject to change.
Feedback and bug reports regarding the Java language binding are welcome please send them to
George Nash - george.nash (at) intel.com

All other bugs should be reported using IoTivities
[Jira bug reporting website](https://jira.iotivity.org/projects/LITE).
