<!DOCTYPE html>
  <html lang="en">
  <head>
    <title>IoT Demo</title>
    <link rel="stylesheet" href="include/page.css">
    <link rel="stylesheet" href="include/jquery-ui.min.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body>
	  <div class='wrapper'>
<header>
	<img src="include/images/ocf-logo.png" style="float:left;max-width:50%">
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="include/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
      <script>
      var imagePath = 'include/images/';

      var stack = []; 

  $( function() {
	  $( "#accordion" ).accordion({
	  collapsible: true,
	  heightStyle: "content",
	  });
	$('#accordion .ui-accordion-content').show();
  } );

function showWait(parentId){
	var b = document.getElementById(parentId);
	var image = document.createElement("img");
	image.setAttribute('id',parentId+'_wait_image');
	image.setAttribute('src',imagePath+'loader.gif');
	b.append(image);
}

  function hideWait(parentId){
	try{
		var d = document.getElementById(parentId+'_wait_image');
		d.remove();
	}catch{
	}
  }


  </script>
</header>
<section>
	<button id='button_discover' type="button" class="w3-button w3-round-large w3-light-blue" onclick="discover_devices()">Discover Devices </button>
    <script src="include/html5-qrcode.min.js"></script>
	<div id="qr-reader" style="width:500px"></div>
	<div id="qr-reader-results">Hello</div>
    <script>

var resultContainer = document.getElementById('qr-reader-results');
var lastResult, countResults = 0;

function onScanSuccess(decodedText, decodedResult) {
    if (decodedText !== lastResult) {
        ++countResults;
        lastResult = decodedText;
        // Handle on success condition with the decoded message.
        console.log(`Scan result ${decodedText}`, decodedResult);
	var results = document.getElementById('qr-reader-results');
	results.innerHTML=decodedText;
    }
}

var html5QrcodeScanner = new Html5QrcodeScanner(
    "qr-reader", { fps: 10, qrbox: 250 });
html5QrcodeScanner.render(onScanSuccess);

    </script>
<div id="accordion">
  <h3>Unowned Devices</h3>
  <div id="unowned_devices">
  </div>
  <h3>Owned Devices</h3>
  <div id="owned_devices">
  </div>
</div>

    <div id='device_container' class="message_holder"></div>


<style>
    .ui-progressbar-value {
      background: lightgreen;
    }
      .progress-label {
    position: absolute;
    top: 4px;
    font-weight: bold;
  }
</style>
    <script type="text/javascript">
      var imagePath = 'include/images/';
      function buildDevice(uuid, ownedState){
		var card = document.createElement("div");
			card.setAttribute('id',uuid);
			card.setAttribute('class','w3-card-4 w3-grey w3-round');
			card.setAttribute('style','width:220px;padding:5px;float:left;min-height:200px;margin:5px;display:none');
		    var label = document.createElement("header");
			    label.setAttribute('class','w3-container w3-light-grey w3-round');
			    label.setAttribute('id','label_'+uuid);
			    label.setAttribute('style','margin:5px;font-size:15px;');
	      		    label.innerHTML=uuid;
		    var imageContainer = document.createElement("div");
			    imageContainer.setAttribute('class','w3-container w3-round');
			    imageContainer.setAttribute('id','image_container_'+uuid);
			    imageContainer.setAttribute('style','margin:5px;position:relative;border:2px solid lightgrey;');
			    var image = document.createElement("img");
				    image.setAttribute('id','image_'+uuid);
				    image.setAttribute('src',imagePath+'unknown.png');
				    image.setAttribute('style','width:100%;margin:5px');
	      		   imageContainer.append(image);

		    var statusContainer = document.createElement("div");
			    statusContainer.setAttribute('class','w3-container w3-light-grey w3-round');
			    statusContainer.setAttribute('style','margin:5px;font-size:12px;padding:2px');
			    statusContainer.setAttribute('id','statusi_container_'+uuid)
			    var statusTxt = document.createElement("div");
				statusTxt.setAttribute('id','statusTxt_'+uuid);
				statusTxt.setAttribute('style','margin:5px;float:left');
				statusTxt.innerHTML = "<b>"+ownedState+"</b>";
			    statusContainer.append(statusTxt);
	      		    var button = document.createElement("div");
				button.setAttribute('id','statusbutton_'+uuid);
				button.setAttribute('onclick','onboardDevice("'+uuid+'")');
	      			button.setAttribute('class','w3-button w3-green w3-round-large');
				button.setAttribute('style','margin:2px;float:right;font-size:20px');
	      			button.innerHTML = "+";
	      		    statusContainer.append(button);

	      card.append(label);
	      card.append(imageContainer);
	      card.append(statusContainer);
	      return card;
      }

	

      function addDevice(parentId, device) {
	    // Adds an element to the document
	    //var p = document.getElementById(parentId);
	    var p = document.getElementById(parentId);
	    p.append(device);
	    $(device).show("bounce",{times:2,distance:10},900);
	}

	function removeDevice(uuid) {
	    // Removes an element from the document
	    try{
		    var element = document.getElementById(uuid);
		    element.parentNode.removeChild(element);
	    }catch{
		//pass
	    }
	}



	/*Socket setup*/
	var socket = io.connect('http://' + document.domain +  ':' + location.port);

	/*OBT is up and running*/
     socket.on( 'obt_initialized', function( msg ) {
        console.log( msg )
      })


	/*Return of Unowned Devices*/
     socket.on( 'unowned', function( msg ) {
        console.log( msg )
	var discovery = JSON.parse(msg);
	for (var key in discovery) {
	    if (discovery.hasOwnProperty(key)) {
		console.log(key + " -> " + discovery[key]);
		newDevice = buildDevice(discovery[key],"unowned");
		addDevice('unowned_devices',newDevice);
	    }
	}
      })
	/*Return of owned Devices*/
     socket.on( 'owned', function( msg ) {
        console.log( "Owned "+msg )
	var discovery = JSON.parse(msg);
	for (var key in discovery) {
	    if (discovery.hasOwnProperty(key)) {
		console.log(key + " -> " + discovery[key]);
		newDevice = buildDevice(discovery[key],"owned");
		addDevice('owned_devices',newDevice);
	    }
	}
	  hideWait('button_discover');
	  for (var i=0;i<stack.length;i++){
		console.log(stack[i]);
	    }
      })


	/*Button callbacks*/

	function onboardDevice(uuid){
		console.log("Perform Ownership of UUID:"+uuid);
		showWait('statusbutton_'+uuid);
		stack.push(uuid);
		socket.emit("onboard_device",uuid);
		discover_owned();        
	}
	function discover_owned(){
		console.log( 'Get owned Devices' )
		socket.emit("discover_owned","data");
	}

	function discover_unowned(){
		console.log( 'Get Unowned Devices' )
		socket.emit("discover_unowned","data");
	}
	function discover_devices(){
        console.log( 'Get Devices' )
	showWait('button_discover');
	socket.emit("discover_devices","data");
	}

	// This is for testing UI
	newDevice = buildDevice('bf5a6a4f-e94d-4df6-61ed-0178af45b135',"unowned");
	addDevice('unowned_devices',newDevice);

	newDevice = buildDevice('bf5a6a4f-e94d-4df6-61ed-0178af45b136',"unowned");
	addDevice('owned_devices',newDevice);



    </script>
</section>
<footer>
  <p>Cablelabs/SCTE Demo</p>
</footer>
	  </div>
  </body>
  </html>
