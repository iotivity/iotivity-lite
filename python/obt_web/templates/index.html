<!DOCTYPE html>
  <html lang="en">
  <head>
    <title>IoT Demo</title>
    <link rel="stylesheet" href="include/page.css">
    <link rel="stylesheet" href="include/jquery-ui.min.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body>
	  <div class='wrapper'>
<header>
	<img src="include/images/cablelabs-logo.png"><h2>Streamlined Onboarding Demo</h2>
</header>
<section>
    <div id='device_container' class="message_holder"></div>


    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="include/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
<style>
    .ui-progressbar-value {
      background: lightgreen;
    }
      .progress-label {
    position: absolute;
    top: 4px;
    font-weight: bold;
  }
</style>
    <script type="text/javascript">

    var devices = []
    var device_flows ={};
    var device_flows_miss ={};
    var total_device_flows = {}

    var cnt = 0;
    //This updates the device graphs
    setInterval(function(){
        var i;
        for (i=0; i< devices.length; i++){
            //console.log(device_flows[devices[i]])
            try{
                update_graph(devices[i],0,0)
            }
            catch{
            //pass
            }
        }
    },3000);


	var imagePath = 'include/images/';
	function buildDevice(mac_id,mac,ip,packets,type,confidence,complexity,flows){
	    var card = document.createElement("div");
	    card.setAttribute('id',mac_id);
	    card.setAttribute('class','w3-card-4 w3-grey w3-round');
	    card.setAttribute('style','width:220px;padding:5px;float:left;min-height:200px;margin:5px;display:none');
		    var label = document.createElement("header");
			    label.setAttribute('class','w3-container w3-light-grey w3-round');
			    label.setAttribute('id','label_'+mac_id);
			    label.setAttribute('style','margin:5px;font-size:15px;');
			    label.innerHTML=type.toUpperCase();
		    if (type.length <= 10){ 
			    label.setAttribute('style','margin:5px;font-size:20px');
		    }else{
			    label.setAttribute('style','margin:5px;font-size:15px;min-height:30px');
		    }
		    var imageContainer = document.createElement("div");
		    imageContainer.setAttribute('class','w3-container w3-round');
            imageContainer.setAttribute('id','image_container_'+mac_id);
		    imageContainer.setAttribute('style','margin:5px;position:relative;border:2px solid lightgrey;');
			    var image = document.createElement("img");
			    image.setAttribute('id','image_'+mac_id);
			    image.setAttribute('src',imagePath+'unknown.png');
			    image.setAttribute('style','width:100%;margin:5px');
                image.setAttribute('onclick','toggle_behavior("'+mac_id+'")');
			    var capture = document.createElement("div");
			    capture.setAttribute('id','capture_'+mac_id);
			    capture.setAttribute('style','width:90%;margin:5px;position:absolute;top:110px;left:0px;display:none;');
			    var progress=  document.createElement("div");
			    progress.setAttribute('id','progress_'+mac_id);
			    progress.setAttribute('class','progress-label');
			    progress.setAttribute('style','position:absolute;');
		            capture.append(progress);
			    var analyze = document.createElement("img");
			    analyze.setAttribute('id','analyze_'+mac_id);
			    analyze.setAttribute('src',imagePath+'analyze.gif');
			    analyze.setAttribute('style','width:90%;height:100%;margin:5px;position:absolute;top:0px;left:0px;display:none');
                var behaviorContainer = document.createElement("div");
                behaviorContainer.setAttribute('class','w3-container w3-round');
                behaviorContainer.setAttribute('id','behavior_container_'+mac_id);
                behaviorContainer.setAttribute('style','width:100%;height:100%;padding:5px;position:absolute;top:0px;left:0px;display:none;background:rgba(0,0,0,0.3)');
                behaviorContainer.setAttribute('onclick','toggle_behavior("'+mac_id+'")');
                    var behaviorHeader = document.createElement("div")
                    var complexityContainer = document.createElement("div")
                    complexityContainer.setAttribute('class','w3-container w3-light-grey w3-round');
                    complexityContainer.setAttribute('style','margin:1px;font-size:12px;');
                        var complexityTxt = document.createElement("div")
                        complexityTxt.setAttribute('id','complexity_'+mac_id);
                        complexityTxt.innerHTML = "<b>Complexity: </b>" + complexity;
                        var flowsTxt = document.createElement("div")
                        flowsTxt.setAttribute('id','flows_'+mac_id);
                        flowsTxt.innerHTML = "<b>Boundary Flows: </b>" + flows;
                        var totalflowsTxt = document.createElement("div")
                        totalflowsTxt.setAttribute('id','total_flows_'+mac_id);
                        totalflowsTxt.innerHTML = "<b>Total Flows: </b>" + flows;
                        var outlierflowsTxt = document.createElement("div")
                        outlierflowsTxt.setAttribute('id','outlier_flows_'+mac_id);
                        outlierflowsTxt.innerHTML = "<b>Outier Flows: </b>" + flows;
                        complexityContainer.append(complexityTxt)
                        complexityContainer.append(flowsTxt)
                        complexityContainer.append(totalflowsTxt)
                        complexityContainer.append(outlierflowsTxt)
                    var flowGraph = document.createElement("div")
                    flowGraph.setAttribute('class','w3-container w3-light-grey w3-round');
                    flowGraph.setAttribute('style','margin:5px;font-size:12px;');
                    flowGraph.setAttribute('id','flow_graph_'+mac_id);
                    behaviorContainer.append(complexityContainer)
                    //behaviorContainer.append(flowGraph)
                imageContainer.append(image)
                imageContainer.append(capture)
                imageContainer.append(analyze)
                imageContainer.append(behaviorContainer)
		    var labelContainer = document.createElement("div");
		    labelContainer.setAttribute('class','w3-container w3-light-grey w3-round');
		    labelContainer.setAttribute('style','margin:5px;font-size:12px');
			    var ipTxt = document.createElement("div"); 
				ipTxt.setAttribute('id','ip_'+mac_id)
				ipTxt.innerHTML = "<b>IP: </b>" + ip;
			    var packetsTxt = document.createElement("div");
				packetsTxt.setAttribute('id','packets_'+mac_id)
				packetsTxt.innerHTML = "<b>Packets: </b>" + packets;
			    var macTxt = document.createElement("div"); 
				macTxt.innerHTML = "<b>MAC: </b>" + mac;
			    labelContainer.append(macTxt);
			    labelContainer.append(ipTxt);
			    //labelContainer.append(packetsTxt);
		    var statusContainer = document.createElement("div");
		    statusContainer.setAttribute('class','w3-container w3-light-grey w3-round');
		    statusContainer.setAttribute('style','margin:5px;font-size:12px');
			    var statusTxt = document.createElement("div"); 
				statusTxt.setAttribute('id','status_'+mac_id)
				statusTxt.innerHTML = "<b>NEW Device Detected</b>";
			    statusContainer.append(statusTxt);
	    card.append(label);
	    card.append(statusContainer);
	    card.append(imageContainer);
	    card.append(labelContainer);
            devices.push(mac_id)
            device_flows[mac_id] = [0];
            device_flows_miss[mac_id] = [0];
            total_device_flows[mac_id] = [0];
            //add_graph(mac_id)
	    return card;
	}



    function addDevice(parentId, device) {
	    // Adds an element to the document
	    var p = document.getElementById(parentId);
	    p.append(device);
	    $(device).show("bounce",{times:2,distance:10},900); 
	    //$("#capture_"+'1234').progressbar({ value: 37 });
	    //$("#progress_"+'1234').text("Capturing:"+37);
            //add_graph(device.id)
	}

	function removeElement(elementId) {
	    // Removes an element from the document
	    try{
		    var element = document.getElementById(elementId);
		    element.parentNode.removeChild(element);
	    }catch{
		//pass
	    }
	}


    function toggle_behavior(container){
        mac = container.substring(container.length-12,container.length)
        $("#behavior_container_"+mac).slideToggle("slow")
    }


	function capture(device){
        $("#image_container_"+device).css("background-color","rgba(0,0,0,0.5)")
	    $("#capture_"+device).progressbar({ value: 0 });
		$("#capture_"+device).show();
		$("#progress_"+device).text("Capturing:");
		//$("#status_"+device).html("<b>Capturing Data</b>");
	}
	
	function fingerprint(device){
		$("#capture_"+device).hide();
		$("#analyze_"+device).show();
		$("#status_"+device).html("<b>Fingerprinting Device</b>");
	}

	function analyzed(device,type,confidence,name){
		$("#analyze_"+device).hide();
		if (type != null){
                        label = "<b>"+type.toUpperCase()+":</b><br>"+name.toUpperCase();
                        if (label.length >= 10){
                            $("#label_"+device).attr('style','font-size:15px');
                        }
			$("#label_"+device).html(label);
			$("#image_"+device).attr('src',imagePath+type+".png");
		}else{
			$("#image_"+device).attr('src',imagePath+"unknown.png");
		}
		$("#status_"+device).html("<b>Confidence: </b>"+confidence);
        $("#image_container_"+device).css("background-color","grey")
	}

        function add_graph(device){
        var layout = {
                  title:"Net Flows",
                  xaxis: {
                    autorange: true,
                    showgrid: false,
                    zeroline: false,
                    showline: false,
                    autotick: true,
                    ticks: '',
                    showticklabels: false
                  },
                  yaxis: {
                    autorange: true,
                    showgrid: false,
                    zeroline: false,
                    showline: false,
                    autotick: true,
                    ticks: '',
                    showticklabels: false
                  },
                  margin:{t:0,l:0,r:0,b:0},
                  paper_bgcolor:'rgba(0,0,0,0)',
                    plot_bgcolor:'rgba(0,0,0,0)',
                  width:150,height:90
              };
        //var trace = {type:"scatter",mode:"lines", line:{color:'green'}, y: device_flows[device], name:'Total Flows'};
        var trace2 = {type:"scatter",mode:"lines", y: device_flows_miss[device],name:'Missed Flows'};
        var data = [trace2]        
        Plotly.newPlot( "flow_graph_"+device,data,layout);

        }


        function update_graph(device,total_flows,miss_flows){
            console.log(device_flows_miss[device])
            /*
            device_flows[device].push(total_flows)
            if (device_flows[device].length >10) {
                device_flows[device].shift()
            }
            device_flows_miss[device].push(miss_flows)
            if (device_flows_miss[device].length >10) {
                device_flows_miss[device].shift()
            }
            //console.log( device_flows );
            Plotly.update("flow_graph_"+device, {y:[device_flows[device],device_flows_miss[device]]},[0,1]);
            */
        }

        /*
	// This is for testing UI
	newDevice = buildDevice('1234','','1.2.3.4','26','unknown','76%','300','230');
	addDevice('device_container',newDevice);	
	analyzed('1234','smartphone','90%','Unknown')
        //add_graph('1234')
	
	newDevice = buildDevice('deadbeefcafe','DE:AD:BE:EF:CA:FE','1.2.3.4','26','unknown','76%','20','12');
	addDevice('device_container',newDevice);	
	analyzed('deadbeefcafe','unknown','N/A','Unknown');
        //add_graph('deadbeefcafe')
        //update_graph('deadbeefcafe',3)
	//fingerprint('deadbeefcafe')
	//
      */
      var socket = io.connect('http://' + document.domain +  ':' + location.port);

      socket.on( 'device_add', function( device ) {
        console.log( device )
	newDevice = buildDevice(device.mac_id,device.mac,device.ip,'0',device.name,'N/A','0','0');
	addDevice('device_container',newDevice);	
	//$(new_div).show('slow')
      })
     

     socket.on( 'device_update', function( device ) {
        console.log( device );
	    var action = device.action;
	    switch(action){
	    	case 'capture':
	     		capture(device.mac_id);
		       $("#progress_"+device.mac_id).text("Capturing: Waiting...");
	     		break;
	    	case 'fingerprint':
	     		fingerprint(device.mac_id);
	     		break;
	    	case 'analyzed':
	     		analyzed(device.mac_id,device.type,device.confidence,device.name);
	     		break;
	     	case 'packets':
		    $("#capture_"+device.mac_id).progressbar({value:parseInt(device.packets)});
		    $("#progress_"+device.mac_id).text("Capturing: "+device.packets);
                        break;
                case 'complexity':
	     	    $("#complexity_"+device.mac_id).html("<b>Complexity: </b>"+device.complexity);
                    break;
                case 'boundary':
	     	    $("#flows_"+device.mac_id).html("<b>Boundary Flows: </b>"+device.boundary_flows);
                    break;
                case 'flows':
                    var i;
                    for (i=0;i < devices.length;i++){
                        if (devices[i] == device.mac_id){
                            currentTotal = parseInt(total_device_flows[devices[i]]);
                            currentTotal += parseInt(device.total);
                            total_device_flows[devices[i]] = currentTotal;
                            $("#total_flows_"+device.mac_id).html("<b>Total Flows: </b>"+total_device_flows[devices[i]]);
                            currentOutlier = parseInt(device_flows_miss[devices[i]]);
                            currentOutlier += parseInt(device.outlier);
                            device_flows_miss[devices[i]] = currentOutlier;
                            $("#outlier_flows_"+device.mac_id).html("<b>Outlier Flows: </b>"+device_flows_miss[devices[i]]);
                            //update_graph(devices[i],0,currentOutlier);
                        }
                    }
                    break;
	    }
      })


     socket.on( 'device_remove', function( msg ) {
        console.log( msg )
	removeElement(msg.mac_id)
      })
    </script>
</section>
<footer>
  <p>Cablelabs/SCTE Demo</p>
</footer>
	  </div>
  </body>
  </html>
