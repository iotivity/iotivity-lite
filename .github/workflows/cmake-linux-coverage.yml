name: Run unit tests and integration tests to gather code coverage

on:
  workflow_call:

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  cmake_linux_coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: "true"

      - name: Build
        run: |
          mkdir linuxbuild
          cd linuxbuild
          cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_VERBOSE_MAKEFILE=ON -DOC_CLOUD_ENABLED=ON -DOC_COLLECTIONS_IF_CREATE_ENABLED=ON -DOC_MNT_ENABLED=ON -DOC_WKCORE_ENABLED=ON -DOC_SOFTWARE_UPDATE_ENABLED=ON -DOC_PUSH_ENABLED=ON -DBUILD_TESTING=ON ..
          make oc-unittests

      - name: Run unit tests
        run: |
          cd linuxbuild
          ctest --verbose --label-regex "oc-unittest"

      - name: Collect coverage data
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gcovr
          ./tools/collect-coverage.sh --build-dir linuxbuild --output-file coverage-unit.xml

      - name: Upload coverage data
        uses: actions/upload-artifact@v3
        with:
          name: unit-test-coverage
          path: tools/coverage-unit.xml
          if-no-files-found: error
          retention-days: 1
