# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Create and publish docker images

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref_name != 'master' }}

on:
  push:
    branches:
      - "master"
    tags:
      - "*"
  pull_request:
    branches:
      - master
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push-images:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: cloud-server
            build_type: Release
            build_args: ""
            file: docker/apps/Dockerfile.cloud-server
          - name: cloud-server-debug
            build_type: Debug
            build_args: "-DOC_DEBUG_ENABLED=ON"
            file: docker/apps/Dockerfile.cloud-server-debug
          - name: cloud-server-discovery-resource-observable
            build_type: Release
            build_args: "-DOC_DISCOVERY_RESOURCE_OBSERVABLE_ENABLED=ON"
            file: docker/apps/Dockerfile.cloud-server
          - name: cloud-server-discovery-resource-observable-debug
            build_type: Debug
            build_args: "-DOC_DEBUG_ENABLED=ON -DOC_DISCOVERY_RESOURCE_OBSERVABLE_ENABLED=ON"
            file: docker/apps/Dockerfile.cloud-server-debug
    uses: ./.github/workflows/docker-build-publish-tag.yml
    with:
      name: ${{ matrix.name }}
      build_type: ${{ matrix.build_type }}
      build_args: -DOC_COLLECTIONS_IF_CREATE_ENABLED=ON -DOC_MNT_ENABLED=ON -DOC_OSCORE_ENABLED=OFF -DOC_RESOURCE_ACCESS_IN_RFOTM_ENABLED=ON ${{ matrix.build_args }}
      file: ${{ matrix.file }}
      release: 2.2.5.4
